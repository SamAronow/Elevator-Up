<!DOCTYPE html>
<html>
<head>
  <title>Elevator Up</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .section { margin-bottom: 20px; }
    .cards { font-size: 24px; }
    .card-button {
      margin: 5px;
      padding: 10px;
      font-size: 20px;
      cursor: pointer;
    }
  
    .card-button:disabled {
      cursor: not-allowed;
      background-color: #ccc;
    }
  </style>
  
  <script>
    var turn=1
    var player = getPlayerFromURL();
    var code = getCodeFromURL();
    if (player==1){
        var opponent=2
    }
    else{
        var opponent=1
    }

    function getPlayerFromURL() {
      var params = new URLSearchParams(window.location.search);
      return params.get("player"); // "player1" or "player2"
    }

    function getCodeFromURL() {
      var params = new URLSearchParams(window.location.search);
      return params.get("room"); // "player1" or "player2"
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function deal(deck,count) {
      return deck.splice(0,count);
    }
    
    const cardRank = {
  "2": 1,
  "3": 2,
  "4": 3,
  "5": 4,
  "6": 5,
  "7": 6,
  "8": 7,
  "9": 8,
  "10": 9,
  "L": 10,
  "S": 11,
  "D": 12,
  "N": 13,
  "P": 14
};

    function sortCards(cards) {
        return cards.slice().sort((a, b) => cardRank[a] - cardRank[b]);
    }

    function legalMove(move,lastVal){
        //move: 2-10
        //last: L,P,null
        const numMove = parseInt(move);
        const numLast = parseInt(lastVal);


        // Check if both are numbers from 2 to 10
        if (!isNaN(numMove)) {
            if(!isNaN(numLast)){
                return numMove >= numLast;
            }
            return lastVal=='L' || lastVal==null            
        }
        else{
            return true
        }


        return false; // Default to false for now
    }

    let flashInterval;
    let flashing = false;

    function startFlashingTitle(message) {
    if (flashing) return; // prevent multiple intervals
    flashing = true;

    let showingMessage = false;
    flashInterval = setInterval(() => {
        document.title = showingMessage ? "Pay Attention" : message;
        showingMessage = !showingMessage;
    }, 1000); // toggle every second
    }

    function stopFlashingTitle() {
        clearInterval(flashInterval);
        var isMyTurn = turn === Number(player);
        document.title = isMyTurn ? "Your turn" : "Opponent Turn"
        flashing = false;
    }

    document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    // Tab became active
    stopFlashingTitle();
  }
});



function winner(win) {
    const message = win == player ? "You won!" : "Opponent won!";
    
    const winpopup = document.createElement("div");
    winpopup.style.position = "fixed";
    winpopup.style.top = "0";
    winpopup.style.left = "0";
    winpopup.style.width = "100vw";
    winpopup.style.height = "100vh";
    winpopup.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
    winpopup.style.display = "flex";
    winpopup.style.justifyContent = "center";
    winpopup.style.alignItems = "center";
    winpopup.style.zIndex = "10000";

    const winMessageBox = document.createElement("div");
    winMessageBox.style.background = "#fff";
    winMessageBox.style.padding = "30px";
    winMessageBox.style.borderRadius = "10px";
    winMessageBox.style.fontSize = "24px";
    winMessageBox.textContent = message;

    winpopup.appendChild(winMessageBox);
    document.body.appendChild(winpopup);
}








    function updateHandButtons(enabled, lastVal,deck,hand,ends) {
        let canPlay = false;

    const handButtons = document.querySelectorAll("#hand .card-button");
    const endCards = document.querySelectorAll(".end-card");
    const mystCards = document.querySelectorAll(".myst-card");

    if (hand.length != 0){
        handButtons.forEach(btn => {
            const card = btn.dataset.card;
            const isLegal = legalMove(card, lastVal);
            if (enabled && isLegal) {
                canPlay = true;
            }
            btn.disabled = !(enabled && isLegal);
            btn.style.backgroundColor = enabled ? "#fff" : "#ccc";
            btn.onclick = (enabled && isLegal) ? () => processClick(card,0) : null;
        });
        endCards.forEach(btn => {
            btn.disabled = true;
            btn.style.backgroundColor = "#ccc";
            btn.onclick = null;
        });
        mystCards.forEach(btn => {
            btn.disabled = true;
            btn.style.backgroundColor = "#ccc";
            btn.onclick = null;
        });
    }
    else if (ends.length!=0){
        endCards.forEach(btn => {
            let card = btn.dataset.card;
            let isLegal = legalMove(card, lastVal);
            if (enabled && isLegal) {
                canPlay = true;
            }
            btn.disabled = !(enabled && isLegal);
            btn.style.backgroundColor = enabled ? "#fff" : "#ccc";
            btn.onclick = (enabled && isLegal) ? () => processClick(card,1) : null;
        });
        mystCards.forEach(btn => {
            btn.disabled = true;
            btn.style.backgroundColor = "#ccc";
            btn.onclick = null;
        });
    }
    else{
        mystCards.forEach(btn => {
            card = btn.dataset.card;
            canPlay = true;
            btn.disabled = !(enabled);
            btn.style.backgroundColor = enabled ? "#fff" : "#ccc";
            btn.onclick = enabled ? () => processClick(card,2) : null;
        });
    }

    // Only append "Take Cards" button if no moves are possible
    if (enabled && !canPlay) {
        const takeBtn = document.createElement("button");
        takeBtn.id = "take-cards-btn";
        takeBtn.textContent = "Take Cards";
        takeBtn.onclick = () => takeCards(null);


        const handSection = document.getElementById("hand");
        handSection.appendChild(takeBtn);
    }

    return canPlay;
}




    window.onload = initializeGame;

    var initRef = database.ref(`/${code}/initialized`);
    initRef.on('value', async (snapshot) => {
        var inval = snapshot.val();
        if (inval === true) {
            console.log("Game initialized â€” starting game");
            initializeGame();
        }  
    });

  
    function getEnd() {
    return new Promise(async (resolve) => {
        const player = getPlayerFromURL();
        const opponent = player === "1" ? "2" : "1";

        const hand = await read(`/${code}/hands/${player}`);
        let selected = [];

        const popup = document.createElement("div");
        popup.id = "popup";
        popup.style.position = "fixed";
        popup.style.top = "0";
        popup.style.left = "0";
        popup.style.width = "100vw";
        popup.style.height = "100vh";
        popup.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
        popup.style.display = "flex";
        popup.style.flexDirection = "column";
        popup.style.alignItems = "center";
        popup.style.justifyContent = "center";
        popup.style.zIndex = "1000";

        popup.innerHTML = `
            <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
                <h3>Select 2 cards for your Ends</h3>
                <div id="card-selection" style="margin: 10px;">
                    ${hand.map((card, i) => 
                        `<button data-index="${i}" class="end-select">${card}</button>`).join(" ")}
                </div>
                <button id="confirmEnds" disabled>Confirm</button>
                <div id="waitMessage" style="margin-top: 10px;"></div>
            </div>
        `;
        document.body.appendChild(popup);

        const buttons = popup.querySelectorAll(".end-select");
        const confirmBtn = popup.querySelector("#confirmEnds");
        const waitMessage = popup.querySelector("#waitMessage");

        buttons.forEach(btn => {
            btn.onclick = () => {
                const index = Number(btn.dataset.index);
                if (selected.includes(index)) {
                    selected = selected.filter(i => i !== index);
                    btn.style.backgroundColor = "";
                } else if (selected.length < 2) {
                    selected.push(index);
                    btn.style.backgroundColor = "lightgreen";
                }

                confirmBtn.disabled = selected.length !== 2;
            };
        });

        confirmBtn.onclick = async () => {
            const ends = [hand[selected[0]], hand[selected[1]]];
            const newHand = hand.filter((_, i) => !selected.includes(i));

            await write(`/${code}/hands/${player}`, newHand);
            await write(`/${code}/ends/${player}`, ends);

            waitMessage.textContent = "Waiting for opponent to choose...";

            // Set listener for opponent's ends
            const endsRef = database.ref(`/${code}/ends/${opponent}`);
            endsRef.on('value', (snapshot) => {
                const opponentEnds = snapshot.val();
                if (Array.isArray(opponentEnds) && opponentEnds.length === 2) {
                    popup.remove();
                    endsRef.off(); // remove listener
                    resolve();     // now resolve the promise
                }
            });
        };
    });
}





    async function initializeGame() {
        var [p1Used, p2Used] = await Promise.all([
            read(`/${code}/Player1/Used`),
            read(`/${code}/Player2/Used`)
        ]);

        if (p1Used && p2Used) {
            var alreadyInit = await read(`/${code}/initialized`);
            if (alreadyInit === true) {
                await getEnd(); 
                var turnRef = database.ref(`/${code}/turn`);
                turnRef.on('value', async (snapshot) => {
                    updateGame()
                });
                
                var mystRef = database.ref(`/${code}/mysteryPlayed`);
                mystRef.on('value', async (snapshot) => {
                    let turn = await read(`/${code}/turn`);
                    let lastVal = await read(`/${code}/lastVal`);

                    var isMyTurn = turn === Number(player);

                    let data = snapshot.val();
                    if (!data || !data.played) return;

                    let card = data.played;
                    console.log("card: ",card)

                    let isLegal = legalMove(card, lastVal);

                    // Remove any existing popup
                    const oldPopup = document.getElementById("popup");
                    if (oldPopup) oldPopup.remove();

                    const popup = document.createElement("div");
                    popup.id = "popup";
                    popup.style.position = "fixed";
                    popup.style.top = "0";
                    popup.style.left = "0";
                    popup.style.width = "100vw";
                    popup.style.height = "100vh";
                    popup.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
                    popup.style.display = "flex";
                    popup.style.justifyContent = "center";
                    popup.style.alignItems = "center";
                    popup.style.zIndex = "1000";

                    const messageBox = document.createElement("div");
                    messageBox.style.background = "#fff";
                    messageBox.style.padding = "30px";
                    messageBox.style.borderRadius = "8px";
                    messageBox.style.textAlign = "center";
                    messageBox.style.fontSize = "20px";

                    const whoPlayed = isMyTurn ? "Your" : "Opponent's";

                    messageBox.innerHTML = `
                        ${whoPlayed} card played was <strong>${card}</strong><br>
                        It is <strong style="color:${isLegal ? 'green' : 'red'}">${isLegal ? 'legal' : 'not legal'}</strong>
                    `;

                    popup.appendChild(messageBox);
                    document.body.appendChild(popup);

                    setTimeout(() => {
                    if (isMyTurn) {
                        const actionContainer = document.createElement("div");
                        actionContainer.style.marginTop = "20px";

                        if (isLegal) {
                            const playBtn = document.createElement("button");
                            playBtn.textContent = "Play Card";
                            playBtn.onclick = () => {
                                popup.remove();
                                endTurn(card,1,2)
                            };
                            actionContainer.appendChild(playBtn);
                        } else {
                            const takeBtn = document.createElement("button");
                            takeBtn.textContent = "Take Cards";
                            takeBtn.onclick = () => {
                                popup.remove();
                                takeCards(card);
                            };
                            actionContainer.appendChild(takeBtn);
                        }

                        messageBox.appendChild(actionContainer);
                    } else {
                        messageBox.innerHTML += `<br><br>Waiting for opponent to ${isLegal ? "play" : "take cards"}.`;
                    }
                }, 1200);


                });

                updateGame();
                return;
            }

            var baseDeck = ["D", "P"];
            for (let i = 0; i < 2; i++) {
                for (let j = 2; j <= 10; j++) baseDeck.push(j.toString());
                    baseDeck.push("L", "N", "S");
                   // baseDeck.push("L", "S");

            }
            shuffle(baseDeck);

            var myst1 = deal(baseDeck, 3);
            var myst2 = deal(baseDeck, 3);
            var hand1 = deal(baseDeck, 5);
            var hand2 = deal(baseDeck, 5);

            await Promise.all([
                write(`/${code}/deck`, baseDeck),
                write(`/${code}/mysts/1`, myst1),
                write(`/${code}/mysts/2`, myst2),
                write(`/${code}/hands/1`, hand1),
                write(`/${code}/hands/2`, hand2),
                write(`/${code}/ends/1`, []),
                write(`/${code}/ends/2`, []),
                write(`/${code}/inPlay`, []),
                write(`/${code}/turn`, 1),
                write(`/${code}/mysteryPlayed`, false),
                write(`/${code}/lastMove`, null),
                write(`/${code}/lastVal`, null),
                write(`/${code}/lastAmt`, null),
                write(`/${code}/lastNum`, null),
                write(`/${code}/lastDiscard`, null),
            ]);

            await write(`/${code}/initialized`, true);

        }
        else {
            console.log("Waiting for both players...");
        }
    }

   
    async function processClick(card,stage) {
        if (stage==2){
            console.log("hi")
            await write(`/${code}/mysteryPlayed`, {
                played: card,
                date: Date.now()  // or some turn counter
            });

            return
        }

        let count=0
        if (stage==0){
            count = Array.from(document.querySelectorAll("#hand .card-button"))
                   .filter(btn => btn.dataset.card === card).length;
        }
        if (stage==1){
            count = Array.from(document.querySelectorAll(".end-card"))
                   .filter(btn => btn.dataset.card === card).length;
        }




  if (count === 1 || card=='L' || card=='S' || card=='N') {
    endTurn(card, 1,stage);
    return;
  }

  // Create overlay
  const overlay = document.createElement("div");
  overlay.className = "popup-overlay";
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
  overlay.style.zIndex = "9998";

  // Create popup box
  const popup = document.createElement("div");
  popup.className = "popup";
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "white";
  popup.style.padding = "20px";
  popup.style.border = "2px solid black";
  popup.style.zIndex = "9999";
  popup.innerHTML = `<h3>Select how many '${card}' to play:</h3>`;

  for (let i = 1; i <= count; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.onclick = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(popup);
      endTurn(card, i,stage);
    };
    popup.appendChild(btn);
  }


  document.body.appendChild(overlay);
  document.body.appendChild(popup);
}



  async function endTurn(card,amt,stage) {   
    var [deck,hand,end_cards,myst_cards,lastMove,inPlay,prevAmt] = await Promise.all([
            read(`/${code}/deck`),
            read(`/${code}/hands/${player}`),
            read(`/${code}/ends/${player}`),
            read(`/${code}/mysts/${player}`),
            read(`/${code}/lastMove`),
            read(`/${code}/inPlay`),
            read(`/${code}/lastAmt`),
    ]);


    if (card == 'N') {
        write(`/${code}/lastMove`, 'N');
        write(`/${code}/lastVal`, null);
        write(`/${code}/lastAmt`, 1);
    } 
    else if (!isNaN(parseInt(card)) && (amt == 4 || ((amt + prevAmt) % 4 == 0 && card == lastMove))) {
        write(`/${code}/lastMove`, 'New from 4 of ' + card);
        write(`/${code}/lastVal`, null);
        write(`/${code}/lastAmt`, 4);
    } 
    else if (card == 'D' || card == 'S') {
        write(`/${code}/lastMove`, card);
        if (card == lastMove) {
            write(`/${code}/lastAmt`, amt + prevAmt);
        } else {
            write(`/${code}/lastAmt`, amt);
        }
    } 
    else {
        write(`/${code}/lastMove`, card);
        write(`/${code}/lastVal`, card);
        if (card == lastMove) {
            write(`/${code}/lastAmt`, amt + prevAmt);
        } else {
            write(`/${code}/lastAmt`, amt);
        }
    }



    if (stage==0){
        if (inPlay === null) {
            inPlay = [];
        }
        if (deck === null) {
            deck = [];
        }
        for (i=0; i<amt; i++){
            inPlay.push(card)
            const index = hand.indexOf(card);
            hand.splice(hand.indexOf(card), 1);
            if (deck.length!=0 && hand.length<=2){
                hand.push(deal(deck,1)[0])
            }
        }
        await write(`/${code}/hands/${player}`, hand)
        await write(`/${code}/deck`, deck)
    }
    if (stage==1){
        if (inPlay === null) {
            inPlay = [];
        }
        if (end_cards === null) {
            end_cards = [];
        }
        for (i=0; i<amt; i++){
            inPlay.push(card)
            const index = end_cards.indexOf(card);
            end_cards.splice(end_cards.indexOf(card), 1);
        }
        await write(`/${code}/ends/${player}`, end_cards)
    }
    if (stage==2){
        if (inPlay === null) {
            inPlay = [];
        }
        if (myst_cards === null) {
            myst_cards = [];
        }
        inPlay.push(card)
        const index = myst_cards.indexOf(card);
        myst_cards.splice(myst_cards.indexOf(card), 1);
        await write(`/${code}/mysts/${player}`, myst_cards)
    }
    
    if (turn==1){
        newTurn=2
    }
    else{
        newTurn=1
    }
    if (card =='N' || (!isNaN(parseInt(card)) && (amt==4 || ((amt+prevAmt)%4==0 && card==lastMove)))){
        write(`/${code}/inPlay`,[])
    }
    else{
        write(`/${code}/inPlay`,inPlay)
    }

    //swtich turns
    write(`/${code}/turn`,newTurn)
    if (card =='N' || card =='D' || (!isNaN(parseInt(card)) && (amt==4 || ((amt+prevAmt)%4==0 && card==lastMove)))){
        write(`/${code}/turn`,turn)   
    }
}


async function takeCards(card){
    var [hand,inPlay,myst_cards] = await Promise.all([
            read(`/${code}/hands/${player}`),
            read(`/${code}/inPlay`),
            read(`/${code}/mysts/${player}`)
        ]);
    if (inPlay === null) {
        inPlay = [];
    }
    if (hand === null) {
        hand = [];
    }
    if (card!=null) {
        if (myst_cards === null) {
            myst_cards = [];
        }
        inPlay.push(card)
        const index = myst_cards.indexOf(card);
        myst_cards.splice(myst_cards.indexOf(card), 1);
        await write(`/${code}/mysts/${player}`, myst_cards)
    }
    

    hand.push(...inPlay);
    inPlay=[]

    if (turn==1){
        newTurn=2
    }
    else{
        newTurn=1
    }

    write(`/${code}/lastMove`, null);
    write(`/${code}/lastVal`, null);
    write(`/${code}/lastAmt`, null);

    await write(`/${code}/inPlay`, inPlay);
    await write(`/${code}/hands/${player}`, hand);
    await write(`/${code}/turn`, newTurn);


}



   
async function updateGame() {
    var [deck,inPlay,hand, opponentHand, ends, opponentEnds, mysts,opponentMysts, lastMove, lastVal, lastAmt] = await Promise.all([
        read(`/${code}/deck`),
        read(`/${code}/inPlay`),
        read(`/${code}/hands/${player}`),
        read(`/${code}/hands/${opponent}`),
        read(`/${code}/ends/${player}`),
        read(`/${code}/ends/${opponent}`),
        read(`/${code}/mysts/${player}`),
        read(`/${code}/mysts/${opponent}`),
        read(`/${code}/lastMove`),
        read(`/${code}/lastVal`),
        read(`/${code}/lastAmt`)
    ]);




    if (inPlay === null) inPlay = [];
    if (deck === null)  deck = [];
    if (hand === null) hand = [];
    if (opponentHand === null) opponentHand = [];
    if (opponentEnds === null) opponentEnds = [];
    if (ends === null) ends = [];
    if (mysts === null) mysts = []
    if (opponentMysts === null) opponentMysts=[]


    deck_len=deck.length
    play_len=inPlay.length



    turn = await read(`/${code}/turn`);
    
    hand = sortCards(hand);


    hand = sortCards(hand);

    var isMyTurn = turn === Number(player);

    document.title = isMyTurn ? "Your turn" : "Opponent Turn"

    const isTabActive = document.visibilityState === 'visible';
    if (!isTabActive) {
        startFlashingTitle("Your Turn!");
    }


    let lastMoveText = "Last played: None";
    if (lastMove != null) {
        const extra = (lastMove === "D" || lastMove === "S") ? ` (on ${lastVal})` : "";
        lastMoveText = `Last played: ${lastMove}${extra}`;
    }

    document.body.innerHTML = `
        <div class="section">
            <h2>Opponent</h2>
            <div class="cards">Hand: ${"X ".repeat(opponentHand.length).trim()}</div>
            <div class="cards">Ends: ${opponentEnds.join(" ")}</div> 
            <div class="cards">Mystery: ${"X ".repeat(opponentMysts.length).trim()}</div>
        </div>

        <hr>

        <div class="section">
            <pre>Cards in Deck: ${deck_len}</pre>
            <pre>Cards in Play: ${play_len}</pre>
            <h3>Last played:</h3>
            <pre>${lastMoveText}</pre>
            <pre>Quantity: ${lastAmt}</pre>
        </div>

        <div class="section">
            <h2>You (${player})</h2>
            <div class="cards" id="hand">
                ${hand.map(card => 
                    `<button class="card-button" data-card="${card}">${card}</button>`
                ).join(" ")}
            </div>

            <div class="cards" id="ends">
                <p>Ends </p>
    ${ends.map(card =>
        `<button class="card-button end-card" data-card="${card}">${card}</button>`
    ).join(" ")}
</div>
            <div class="cards" id="ends">
                <p>Mystery </p>
    ${mysts.map(card =>
        `<button class="card-button myst-card" data-card="${card}">X</button>`
    ).join(" ")}
</div>
        </div>

        <div class="section">
            <h3 id="turn-status">${isMyTurn ? "Your turn" : "Waiting for opponent..."}</h3>
        </div>
    `;


    // Normal hand interaction
    canPlay = updateHandButtons(isMyTurn, lastVal,deck,hand,ends);

    if (hand.length==0 && ends.length==0 && mysts.length==0){
        winner(player)
    }
    if (opponentHand.length==0 && opponentEnds.length==0 && opponentMysts.length==0){
        winner(opponent)
    }
}


  </script>
</head>
<body>
  <h1>Game Setup In Progress...</h1>
</body>
</html>
