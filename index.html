<script>
  let roomCode = null;

  function randomCode(length = 4) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    return Array.from({ length }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
  }

  async function createRoom() {
    roomCode = randomCode();
    await Promise.all([
      write(`/${roomCode}/Player1/Used`, false),
      write(`/${roomCode}/Player2/Used`, false),
      write(`/${roomCode}/initialized`, false)
    ]);

    // Add the room code to the URL
    const newUrl = `${window.location.pathname}?room=${roomCode}`;
    window.history.pushState({}, '', newUrl);

    showRoomCode();
    showPlayerButtons();
  }

  function joinRoom() {
    let code = prompt("Enter room code:");
    if (!code) return;
    code = code.toUpperCase();
    attemptJoin(code);
  }

  function attemptJoin(code) {
    const path = `/${code}/initialized`;
    read(path).then(exists => {
      if (exists !== null) {
        roomCode = code;
        showRoomCode();
        showPlayerButtons();
      } else {
        alert("Room not found!");
      }
    });
  }

  function showRoomCode() {
    const display = document.getElementById("room-code-display");
    display.textContent = `Room Code: ${roomCode}`;
  }

  function showPlayerButtons() {
    document.getElementById("room-select").style.display = "none";
    document.getElementById("player-select").style.display = "block";

    firebase.database().ref(`${roomCode}/Player1/Used`).on("value", snapshot => {
      if (snapshot.val() === true) disableButton(1);
    });

    firebase.database().ref(`${roomCode}/Player2/Used`).on("value", snapshot => {
      if (snapshot.val() === true) disableButton(2);
    });
  }

  function disableButton(playerNum) {
    const btn = document.getElementById(`player${playerNum}-btn`);
    btn.disabled = true;
    btn.classList.add("taken");
    btn.innerText = `Taken (Player ${playerNum})`;
  }

  function selectPlayer(num) {
    const usedPath = `/${roomCode}/Player${num}/Used`;
    read(usedPath).then(isUsed => {
      if (isUsed === true) {
        alert(`Player ${num} already joined!`);
      } else {
        write(usedPath, true).then(() => {
          window.location.href = `game.html?player=${num}&room=${roomCode}`;
        });
      }
    });
  }

  // ðŸ”½ Auto-join if `room` is in the URL on page load
  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const codeFromURL = params.get('room');
    if (codeFromURL) {
      attemptJoin(codeFromURL.toUpperCase());
    }
  };
</script>
