<!DOCTYPE html>
<html>
<head>
  <title>Elevator Up - Room</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-bg: linear-gradient(135deg, #1e1e2f 0%, #2d2d44 100%);
      --accent-color: #f0e68c;
      --accent-hover: #e8dc8b;
      --dark-bg: #1a1a2e;
      --darker-bg: #16213e;
    }
    
    .rejoin-btn:hover {
    background-color: #45a049 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}
    body {
      background: var(--primary-bg);
      color: white;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      user-select: none;
    }
    
     .game-title {
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--accent-color);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.6);
      margin-bottom: 2rem;
      letter-spacing: 1px;
    }
    
    .room-code {
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 2px;
      color: var(--accent-color);
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      display: inline-block;
    }
    
    .btn-custom {
      background-color: var(--accent-color);
      color: var(--dark-bg);
      border: none;
      font-weight: 600;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(240, 230, 140, 0.3);
      min-width: 200px;
      font-size: 1.1rem;
    }
    
    .btn-custom:hover {
      background-color: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(240, 230, 140, 0.4);
    }
    
    .btn-custom:active {
      transform: translateY(0);
    }
    
    .btn-dark-custom {
      background-color: var(--darker-bg);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      font-size: 1.1rem;
      padding: 1rem;
      width: 85%; /* Narrower player buttons */
      max-width: 350px; /* Maximum width */
      margin: 0 auto; /* Center the buttons */
    }
    
    .btn-dark-custom:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .btn-dark-custom.taken {
      background-color: #555;
      color: #ccc;
      cursor: not-allowed;
    }
    
    .player-buttons-container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .modal-content {
      background-color: var(--dark-bg);
      color: white;
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      width: 120%; /* Wider modal */
      max-width: 450px; /* But not too wide */
      margin-left: -10%; /* Center adjustment */
    }
    
    .modal-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1.5rem 1.5rem 0.5rem; /* Better spacing */
    }
    
    .modal-footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-control {
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      text-align: center;
      font-size: 1.2rem;
      padding: 0.75rem 1rem;
    }
    
    .form-control:focus {
      background-color: rgba(255, 255, 255, 0.15);
      border-color: var(--accent-color);
      color: white;
      box-shadow: 0 0 0 0.25rem rgba(240, 230, 140, 0.25);
    }
    
    /* Animation for popup */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1050;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out forwards;
    }
    
    .popup-overlay.closing {
      animation: fadeOut 0.2s ease-in forwards;
    }
    
    .modal-content {
      animation: slideUpFadeIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards;
    }
    
    .modal-content.closing {
      animation: slideDownFadeOut 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards;
    }
    
    @keyframes slideDownFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes slideUpFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="container py-5 text-center">
    <h1 class="game-title">Room Lobby</h1>
    <div class="room-code mb-4" id="room-code-display"></div>
    
    <div class="d-flex justify-content-center mb-5">
      <button class="btn btn-custom me-3" id="copy-link-btn">
        <i class="bi bi-clipboard me-2"></i>Copy Room Link
      </button>
    </div>
    
    <h2 class="mb-4" style="color: var(--accent-color);">Select a Player</h2>
    
    <div class="player-buttons-container">
      <div class="d-grid gap-3" id="player-buttons"></div>
    </div>
  </div>

  <!-- Player Name Input Popup -->
  <div id="player-name-popup" class="popup-overlay" onclick="cancelNameEntry()">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-4" onclick="event.stopPropagation()">
        <div class="modal-header border-0 position-relative">
          <h2 class="modal-title w-100 text-center" style="color: var(--accent-color); padding-right: 2rem;">Enter your name</h2>
         <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" style="top: 0.5rem;" onclick="cancelNameEntry()"></button>
        </div>
        <div class="modal-body py-4">
          <input type="text" id="player-name-input" class="form-control form-control-lg mb-4" 
                 maxlength="20" placeholder="Your name" autocomplete="off" />
          <button class="btn btn-custom w-100 py-3 submit-btn">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="database.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get("room");

    document.getElementById("room-code-display").textContent = roomCode;

    // Copy link animation (no alert)
    const copyBtn = document.getElementById("copy-link-btn");
    copyBtn.onclick = () => {
      const roomURL = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
      navigator.clipboard.writeText(roomURL).then(() => {
        copyBtn.innerHTML = '<i class="bi bi-check2 me-2"></i>Copied!';
        copyBtn.disabled = true;
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="bi bi-clipboard me-2"></i>Copy Room Link';
          copyBtn.disabled = false;
        }, 1000);
      });
    };

    let playerCount = 0;
    let selectedPlayerNum = null;
    setupRoom();

    async function setupRoom() {
      playerCount = await read(`/${roomCode}/playerCount`);
      const container = document.getElementById("player-buttons");
      container.innerHTML = "";

      for (let i = 1; i <= playerCount; i++) {
        const btn = document.createElement("button");
        btn.id = `player${i}-btn`;
        btn.className = "btn btn-dark-custom btn-lg";
        btn.innerHTML = `<i class="bi bi-person me-2"></i>Player ${i}`;
        btn.onclick = () => selectPlayer(i);
        container.appendChild(btn);

        // Listen for Used status changes and update button accordingly
        firebase.database().ref(`/${roomCode}/players/${i}/Used`).on("value", snapshot => {
          if (snapshot.val() === true) disableButton(i);
          else enableButton(i);
        });
      }
    }

    function disableButton(playerNum) {
      const btn = document.getElementById(`player${playerNum}-btn`);
      if (btn) {
        btn.disabled = true;
        btn.classList.add("taken");
        btn.innerHTML = `<i class="bi bi-person-x me-2"></i>Player ${playerNum} (Taken)`;
      }
    }

    function enableButton(playerNum) {
      const btn = document.getElementById(`player${playerNum}-btn`);
      if (btn) {
        btn.disabled = false;
        btn.classList.remove("taken");
        btn.innerHTML = `<i class="bi bi-person me-2"></i>Player ${playerNum}`;
      }
    }

    // Add this at the top of your script, before setupRoom()
window.addEventListener("load", async () => {
    const choosingPlayer = localStorage.getItem("choosingPlayer");
    const inGame = localStorage.getItem("inGame");
    const playerNum = localStorage.getItem("player");
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get("room");

    // If we're in the middle of choosing a player (name popup was closed)
    if (!isNaN(parseInt(choosingPlayer)) && choosingPlayer > 0) {
        selectPlayer(parseInt(choosingPlayer));
    }
    // If we have a stored game, check if we can rejoin
    else if (inGame && playerNum) {
        try {
            const snapshot = await firebase.database().ref(`/${inGame}/players/${playerNum}/Used`).once('value');
            if (snapshot.exists() && snapshot.val() === true) {
                showRejoinButton(inGame);
            } else {
                // Clean up if our slot isn't used anymore
                localStorage.removeItem('inGame');
                localStorage.removeItem('player');
                localStorage.removeItem('playerName');
            }
        } catch (error) {
            console.error("Error checking game status:", error);
        }
    }
});

// Add this function to show the rejoin button at bottom
function showRejoinButton(roomCode) {
    // Remove existing rejoin button if any
    const existingBtn = document.querySelector('.rejoin-btn-container');
    if (existingBtn) existingBtn.remove();
    
    const rejoinContainer = document.createElement('div');
    rejoinContainer.className = 'rejoin-btn-container mt-5';
    rejoinContainer.innerHTML = `
        <button class="btn btn-custom rejoin-btn" style="background-color: #4CAF50;">
            <i class="bi bi-arrow-repeat me-2"></i>Rejoin Game (player ${localStorage.getItem('player') || 'unknown'}) 
        </button>
    `;
    
    // Insert at bottom of container (before closing </div>)
    const mainContainer = document.querySelector('.container');
    mainContainer.appendChild(rejoinContainer);
    
    // Add click handler
    document.querySelector('.rejoin-btn').addEventListener('click', async () => {
        const playerName = localStorage.getItem('playerName');
        const playerNum = localStorage.getItem('player');
        
        if (!playerName || !playerNum) return;
        
        try {
            const snapshot = await firebase.database().ref(`/${roomCode}/players/${playerNum}/Used`).once('value');
            if (snapshot.exists() && snapshot.val() === true) {
                window.location.href = `game.html?player=${playerNum}&room=${roomCode}`;
            } else {
                rejoinContainer.remove();
                localStorage.removeItem('inGame');
                localStorage.removeItem('player');
                localStorage.removeItem('playerName');
            }
        } catch (error) {
            console.error("Rejoin failed:", error);
        }
    });
}

// Update your selectPlayer function
async function selectPlayer(num) {
    selectedPlayerNum = num;
    await write(`/${roomCode}/players/${num}/Used`, true);
    localStorage.setItem("choosingPlayer", num);
    const name = await showNamePopup(num);

    if (!name) {
        await write(`/${roomCode}/players/${num}/Used`, false);
        localStorage.removeItem('choosingPlayer');
        setupRoom();
        return;
    }

    localStorage.removeItem('choosingPlayer');
    await write(`/${roomCode}/players/${num}/Name`, name.trim());
    localStorage.setItem("inGame", roomCode);
    localStorage.setItem("player", num);
    localStorage.setItem("playerName", name.trim());
    
    window.location.href = `game.html?player=${num}&room=${roomCode}`;
}


    function showNamePopup(num) {
      return new Promise((resolve) => {
        const popup = document.getElementById("player-name-popup");
        const input = document.getElementById("player-name-input");
        const submitBtn = popup.querySelector("button.submit-btn");

        popup.style.display = "flex";
        input.value = "";
        input.focus();

        function cleanupAndResolve(name) {
          submitBtn.removeEventListener("click", onSubmit);
          popup.style.display = "none";
          resolve(name);
        }

        function onSubmit() {
          const val = input.value.trim();
          if (val.length === 0) return;
          cleanupAndResolve(val);
        }

        submitBtn.addEventListener("click", onSubmit);

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            onSubmit();
          } else if (e.key === "Escape") {
            cleanupAndResolve(null);
          }
        });
      });
    }

    // Cancel name entry: close popup and re-enable the button
    async function cancelNameEntry() {
        localStorage.setItem("choosingPlayer", 0);
      if (selectedPlayerNum !== null) {
        await write(`/${roomCode}/players/${selectedPlayerNum}/Used`, false);
      }
      closeNamePopup();
    }

    function closeNamePopup() {
      const popup = document.getElementById("player-name-popup");
      popup.classList.add("closing");
      const modalContent = popup.querySelector(".modal-content");
      if (modalContent) modalContent.classList.add("closing");
      
      setTimeout(() => {
        popup.style.display = "none";
        popup.classList.remove("closing");
        if (modalContent) modalContent.classList.remove("closing");
      }, 300);
    }

    

  </script>
</body>
</html>