<!DOCTYPE html>
<html>
<head>
  <title>Elevator Up - Room</title>
  <style>
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
    }

    button.taken {
      background-color: #555;
      color: white;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Room Lobby</h1>
  <div id="room-code-display"></div>
  <div><button id="copy-link-btn">Copy Room Link</button></div>
  <h2>Select a Player</h2>
  <div id="player-buttons"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="database.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get("room");

    document.getElementById("room-code-display").textContent = `Room Code: ${roomCode}`;
    document.getElementById("copy-link-btn").onclick = () => {
      const roomURL = `${window.location.origin}${window.location.pathname}?room=${roomCode}`;
      navigator.clipboard.writeText(roomURL).then(() => alert("Room link copied!"));
    };

    let playerCount = 0;
    setupRoom();

    async function setupRoom() {
      playerCount = await read(`/${roomCode}/playerCount`);
      const container = document.getElementById("player-buttons");
      container.innerHTML = "";

      for (let i = 1; i <= playerCount; i++) {
        const btn = document.createElement("button");
        btn.id = `player${i}-btn`;
        btn.textContent = `Player ${i}`;
        btn.onclick = () => selectPlayer(i);
        container.appendChild(btn);

        firebase.database().ref(`/${roomCode}/players/${i}/Used`).on("value", snapshot => {
          if (snapshot.val() === true) disableButton(i);
          if (snapshot.val() === false) enableButton(i);
        });
      }
      //waitForAllPlayers();
    }

    function disableButton(playerNum) {
      const btn = document.getElementById(`player${playerNum}-btn`);
      if (btn) {
        btn.disabled = true;
        btn.classList.add("taken");
        btn.innerText = `Taken (Player ${playerNum})`;
      }
    }

    function enableButton(playerNum) {
        const btn = document.getElementById(`player${playerNum}-btn`);
        if (btn) {
            btn.disabled = false;
            btn.classList.remove("taken");
            btn.innerText = `Player ${playerNum}`;
        }
    }

    async function selectPlayer(num) {
        await write(`/${roomCode}/players/${num}/Used`, true);

        const name = prompt(`Enter your name for Player ${num}:`);
        if (!name || name.trim() === "") {
            alert("Name cannot be empty.");
            setupRoom(); // Re-enable buttons
            await write(`/${roomCode}/players/${num}/Used`, false);
            return;
        }

        await write(`/${roomCode}/players/${num}/Name`, name.trim());

        window.location.href = `game.html?player=${num}&room=${roomCode}`;
    }


/*
    async function waitForAllPlayers() {
      firebase.database().ref(`/${roomCode}`).on('value', snapshot => {
        const data = snapshot.val();
        let allJoined = true;

        for (let i = 1; i <= playerCount; i++) {
          if (!data?.[`Player${i}`]?.Used) {
            allJoined = false;
            break;
          }
        }

        if (allJoined) {
          console.log("All players joined!");
        }
      });
    }*/
  </script>
</body>
</html>
